<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:tls="http://www.mulesoft.org/schema/mule/tls"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:api-gateway="http://www.mulesoft.org/schema/mule/api-gateway"
      xmlns:apikit="http://www.mulesoft.org/schema/mule/mule-apikit"
      xmlns:jms="http://www.mulesoft.org/schema/mule/jms"
      xmlns:context="http://www.springframework.org/schema/context"
      xmlns:db="http://www.mulesoft.org/schema/mule/db"
      xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/jms http://www.mulesoft.org/schema/mule/jms/current/mule-jms.xsd 
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
        http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-current.xsd
http://www.mulesoft.org/schema/mule/mule-apikit http://www.mulesoft.org/schema/mule/mule-apikit/current/mule-apikit.xsd
http://www.mulesoft.org/schema/mule/api-gateway http://www.mulesoft.org/schema/mule/api-gateway/current/mule-api-gateway.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/tls http://www.mulesoft.org/schema/mule/tls/current/mule-tls.xsd">

    <!-- Configuration des propriétés -->
    <configuration-properties doc:name="Configuration properties" doc:id="4b760b28-d454-4810-b76b-1d22ebf44466" file="configs\dev.yaml" />

    <!-- Configuration JMS pour messaging asynchrone -->
    <jms:config name="jmsConfig" doc:name="JMS Config">
        <jms:active-mq-connection>
            <jms:factory-configuration brokerUrl="vm://localhost"/>
        </jms:active-mq-connection>
    </jms:config>
	
	<apikit:config outboundHeadersMapName="outboundHeaders" httpStatusVarName="httpStatus" doc:name="Router" doc:id="2ac83d93-586c-4742-ac79-e00dfa17152f" name="kitinterconnexionuemoa-config" api="kitinterconnexionuemoa.raml" />
	
	<http:listener-config name="kitinterconnexionuemoa-httpListenerConfig" doc:name="HTTP Listener config" doc:id="42898d4a-c1d0-4475-8033-b29adf0f3149" >
		<http:listener-connection host="${http.host}" port="${http.port}" />
	</http:listener-config>
	
	<db:config name="interconnexionDbConfig-2" doc:name="Database Config" doc:id="fa1c65d7-f443-4d11-90b5-1ff95e266ca8" >
		<db:generic-connection url="${db.url_interco}" driverClassName="${db.driver}" user="${db.user}" />
	</db:config>
	
	<!-- CORRECTION: Configuration HTTP Request pour Pays A - SANS PORT EXPLICITE -->
	<http:request-config name="paysAConfig" doc:name="HTTP Request configuration" doc:id="e5417815-7b24-4439-a65b-82d154c8db91" >
		<http:request-connection host="${systeme.paysA.host}" protocol="HTTPS">
			<tls:context >
				<tls:trust-store insecure="true" />
			</tls:context>
			<http:authentication >
				<http:basic-authentication username="admin" password="admin" />
			</http:authentication>
		</http:request-connection>
	</http:request-config>
	
	<!-- CORRECTION: Configuration HTTP Request pour Pays B - SANS PORT EXPLICITE -->
	<http:request-config name="paysBConfig" doc:name="HTTP Request configuration" doc:id="05f90f5a-3e42-48a3-81c5-fd65d50fcbcc" >
		<http:request-connection host="${systeme.paysB.host}" protocol="HTTPS">
			<tls:context >
				<tls:trust-store insecure="true" />
			</tls:context>
		</http:request-connection>
	</http:request-config>
	
	<!-- CORRECTION: Configuration HTTP Request pour Commission - SANS PORT EXPLICITE -->
	<http:request-config name="commissionConfig" doc:name="HTTP Request configuration" doc:id="48c0290c-683e-4651-9923-119bfc2a1093" >
		<http:request-connection host="${commission.uemoa.host}" protocol="HTTPS">
			<tls:context >
				<tls:trust-store insecure="true" />
			</tls:context>
		</http:request-connection>
	</http:request-config>
	
	<db:config name="interconnexionDbConfig" doc:name="Database Config" doc:id="2b60e037-0da5-4844-a355-47717a3f2306" >
		<db:mssql-connection host="localhost" port="1433" user="sa" password="UemoaInterconnexion2025!" databaseName="InterconnexionUEMOA" />
	</db:config>
	
	<error-handler name="global-error-handler" doc:id="f90b91ba-6b87-491b-bb11-22a2538276bd" >
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="d8ec8b9b-18be-4d1c-bb0d-5a2775804520" >
			<ee:transform doc:name="Error Response" doc:id="5c612e82-d4b9-4cb4-8557-5925374cb415" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
    status: "ERROR",
    message: "Erreur lors du traitement",
    error: error.description default "Erreur inconnue",
    timestamp: now()
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<set-variable value="#[500]" doc:name="Set Error Status" doc:id="a8f6e4fc-94cd-4bc3-af3d-2c8704566680" variableName="http.status" />
		</on-error-continue>
	</error-handler>
</mule>