<?xml version="1.0" encoding="UTF-8"?>
<!-- 
FICHIER: src/main/mule/interface.xml CORRIGÉ
Kit d'Interconnexion UEMOA - Endpoints conformes au rapport PDF
Sénégal (Pays A) ↔ Kit MuleSoft ↔ Mali (Pays B)
-->
<mule xmlns="http://www.mulesoft.org/schema/mule/core" 
      xmlns:apikit="http://www.mulesoft.org/schema/mule/mule-apikit" 
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" 
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" 
      xmlns:http="http://www.mulesoft.org/schema/mule/http" 
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd                            
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd                            
        http://www.mulesoft.org/schema/mule/mule-apikit http://www.mulesoft.org/schema/mule/mule-apikit/current/mule-apikit.xsd                            
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

    <!-- ✅ FLOW PRINCIPAL avec CORS amélioré -->
    <flow name="kitinterconnexionuemoa-main" doc:id="f77f8f2c-0acf-4ae1-9048-97512ac843e3">
        <http:listener path="/api/v1/*" config-ref="kitinterconnexionuemoa-httpListenerConfig">
            <http:response statusCode="#[vars.httpStatus default 200]">
                <http:headers><![CDATA[#[vars.outboundHeaders ++ vars.corsHeaders default vars.corsHeaders]]]></http:headers>
            </http:response>
            <http:error-response statusCode="#[vars.httpStatus default 500]">
                <http:body><![CDATA[#[payload]]]></http:body>
                <http:headers><![CDATA[#[vars.outboundHeaders ++ vars.corsHeaders default vars.corsHeaders]]]></http:headers>
            </http:error-response>
        </http:listener>
        
        <!-- ✅ Headers CORS appliqués en premier -->
        <flow-ref doc:name="Set CORS Headers" name="cors-headers" />
        
        <!-- ✅ Gestion OPTIONS pour CORS preflight -->
        <choice doc:name="Handle CORS Preflight">
            <when expression="#[attributes.method == 'OPTIONS']">
                <logger level="INFO" message="🔄 [Kit] CORS Preflight request from: #[attributes.headers['origin'] default 'unknown']" doc:name="Log CORS Preflight" />
                <ee:transform doc:name="CORS Preflight Response">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    message: "CORS preflight successful - Kit Interconnexion UEMOA",
    timestamp: now(),
    allowedMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    allowedHeaders: ["Content-Type", "Authorization", "X-Source-Country", "X-Correlation-ID", "X-Source-System", "X-Payment-Reference", "X-Authorization-Source"],
    kitVersion: "1.0.0-UEMOA",
    supportedWorkflows: ["LIBRE_PRATIQUE", "TRANSIT"]
}]]></ee:set-payload>
                    </ee:message>
                </ee:transform>
                <set-variable value="#[200]" doc:name="Set 200 OK" variableName="httpStatus" />
            </when>
            <otherwise>
                <!-- Route vers APIKit pour les autres méthodes -->
                <apikit:router config-ref="kitinterconnexionuemoa-config" />
            </otherwise>
        </choice>
        
        <error-handler ref="global-error-handler" />
    </flow>
    
    <!-- ✅ Sub-flow CORS amélioré pour Kit UEMOA -->
    <sub-flow name="cors-headers" doc:id="a71f3447-dc5c-4c9d-9c28-56c9dc85424e">
        <set-variable value="#[{
    &quot;Access-Control-Allow-Origin&quot;: &quot;*&quot;,
    &quot;Access-Control-Allow-Methods&quot;: &quot;GET, POST, PUT, DELETE, OPTIONS&quot;,
    &quot;Access-Control-Allow-Headers&quot;: &quot;Content-Type, Authorization, X-Source-Country, X-Correlation-ID, X-Source-System, X-Payment-Reference, X-Authorization-Source, X-Manifeste-Format, X-Workflow-Step&quot;,
    &quot;Access-Control-Max-Age&quot;: &quot;3600&quot;,
    &quot;Access-Control-Allow-Credentials&quot;: &quot;false&quot;,
    &quot;Vary&quot;: &quot;Origin, Access-Control-Request-Method, Access-Control-Request-Headers&quot;,
    &quot;X-Kit-Version&quot;: &quot;1.0.0-UEMOA&quot;,
    &quot;X-Supported-Formats&quot;: &quot;UEMOA_2025.1&quot;
}]" doc:name="Set Enhanced CORS Headers" variableName="corsHeaders" />
        <logger level="DEBUG" message="🔄 [Kit] CORS headers configurés pour requête depuis: #[attributes.headers['origin'] default 'no-origin']" doc:name="Log CORS Setup" />
    </sub-flow>
    
    <!-- ✅ CONSOLE FLOW avec CORS -->
    <flow name="kitinterconnexionuemoa-console" doc:id="d4eb2a64-23b4-428f-91ac-0913db950012">
        <http:listener path="/console/*" config-ref="kitinterconnexionuemoa-httpListenerConfig">
            <http:response statusCode="#[vars.httpStatus default 200]">
                <http:headers><![CDATA[#[vars.outboundHeaders ++ vars.corsHeaders default vars.corsHeaders]]]></http:headers>
            </http:response>
            <http:error-response statusCode="#[vars.httpStatus default 500]">
                <http:body><![CDATA[#[payload]]]></http:body>
                <http:headers><![CDATA[#[vars.outboundHeaders ++ vars.corsHeaders default vars.corsHeaders]]]></http:headers>
            </http:error-response>
        </http:listener>
        
        <flow-ref doc:name="Set CORS Headers" name="cors-headers" />
        <apikit:console config-ref="kitinterconnexionuemoa-config" />
        <error-handler ref="global-error-handler" />
    </flow>
    
    <!-- ✅ ENDPOINTS PRINCIPAUX - Workflow Libre Pratique (21 étapes) -->
    
    <!-- ÉTAPES 4-5: Réception manifeste depuis Sénégal (Pays A) -->
    <flow name="post:\manifeste\transmission:application\json:kitinterconnexionuemoa-config" doc:id="c204fa5c-26bb-448e-8780-933fcd172a53">
        <logger level="INFO" message="📨 [Kit] ÉTAPES 4-5: Réception manifeste depuis Sénégal: #[attributes.headers['x-source-country'] default 'unknown']" doc:name="Log Manifeste Reception" />
        <flow-ref doc:name="Process Manifeste from Senegal" name="receive-manifeste-from-senegal" />
    </flow>
    
    <!-- ÉTAPES 14-16: Réception déclaration depuis Mali (Pays B) -->
    <flow name="post:\declaration\soumission:application\json:kitinterconnexionuemoa-config" doc:id="0ec2abbb-6f53-4df7-866c-e2edd1374f81">
        <logger level="INFO" message="📋 [Kit] ÉTAPES 14-16: Réception déclaration depuis Mali: #[attributes.headers['x-source-country'] default 'unknown']" doc:name="Log Declaration Reception" />
        <flow-ref doc:name="Process Declaration from Mali" name="receive-declaration-from-mali" />
    </flow>
    
    <!-- ÉTAPES 20-21: Traçabilité Commission UEMOA -->
    <flow name="post:\tracabilite\enregistrer:application\json:kitinterconnexionuemoa-config" doc:id="b388bc32-8cc0-441e-a005-9e02060e4516">
        <logger level="INFO" message="📊 [Kit] Traçabilité Commission UEMOA: #[attributes.headers['x-source-system'] default 'unknown']" doc:name="Log Trace Request" />
        <flow-ref doc:name="Process Commission Trace" name="record-commission-trace" />
    </flow>
    
    <!-- ✅ ENDPOINTS TRANSIT - Workflow Transit (16 étapes) -->
    
    <!-- ÉTAPES 1-6: Création déclaration transit depuis Sénégal -->
    <flow name="post:\transit\creation:application\json:kitinterconnexionuemoa-config" doc:id="14dfba47-dc48-4591-801e-284ace656f3f">
        <logger level="INFO" message="🚛 [Kit] ÉTAPES 1-6: Création transit depuis Sénégal: #[attributes.headers['x-source-country'] default 'unknown']" doc:name="Log Transit Creation" />
        <flow-ref doc:name="Process Transit Creation" name="receive-transit-from-senegal" />
    </flow>
    
    <!-- ÉTAPE 14: Message arrivée transit depuis Mali -->
    <flow name="post:\transit\arrivee:application\json:kitinterconnexionuemoa-config" doc:id="c537b5de-582b-4fe2-b831-0862b27b969e">
        <logger level="INFO" message="📥 [Kit] ÉTAPE 14: Message arrivée transit depuis Mali: #[attributes.headers['x-source-country'] default 'unknown']" doc:name="Log Transit Arrival" />
        <flow-ref doc:name="Process Transit Arrival" name="receive-arrival-message-from-mali" />
    </flow>
    
    <!-- ✅ ENDPOINTS DE SUPPORT -->
    
    <!-- Health Check détaillé -->
    <flow name="get:\health:kitinterconnexionuemoa-config" doc:id="ca8edbde-6b1d-41f3-99da-b7efa24a97d2">
        <logger level="INFO" message="🏥 [Kit] Health check demandé depuis: #[attributes.headers['user-agent'] default 'unknown']" doc:name="Log Health Request" />
        <flow-ref doc:name="Execute Health Check" name="health-check" />
    </flow>
    
    <!-- Notification apurement depuis Sénégal (étape 20+) -->
    <flow name="post:\apurement\notification:application\json:kitinterconnexionuemoa-config" doc:id="e4736475-1334-4d9c-95f3-bb0243c84bd5">
        <logger level="INFO" message="🔓 [Kit] Notification apurement depuis Sénégal: #[payload.numeroManifeste default 'unknown']" doc:name="Log Apurement Notification" />
        <ee:transform doc:name="Transform Apurement Response">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    status: "SUCCESS",
    message: "Notification apurement reçue par Kit MuleSoft",
    numeroManifeste: payload.numeroManifeste,
    dateNotification: payload.dateApurement,
    kitProcessing: {
        correlationId: attributes.headers['x-correlation-id'] default uuid(),
        source: "KIT_INTERCONNEXION_UEMOA",
        etapeWorkflow: "20_NOTIFICATION_APUREMENT"
    },
    instructions: [
        "Notification transmise à la Commission UEMOA",
        "Workflow libre pratique en cours de finalisation"
    ],
    timestamp: now()
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
    </flow>
    
    <!-- ✅ ENDPOINTS MANQUANTS SELON RAML -->
    
    <!-- Notification paiement (workflow existant) -->
    <flow name="post:\paiement\notification:application\json:kitinterconnexionuemoa-config" doc:id="00a4772e-3831-4df4-b6ed-91848721ad71">
        <logger level="INFO" message="💳 [Kit] Notification paiement: #[payload.numeroDeclaration default 'unknown'] depuis: #[attributes.headers['x-source-country'] default 'unknown']" doc:name="Log Payment Notification" />
        
        <!-- Stocker dans Supabase -->
        <http:request method="POST" doc:name="Store Payment in Supabase" config-ref="supabaseRestConfig" 
                      path="${supabase.rest.base_path}${supabase.rest.endpoints.paiements}"/>
        
        <ee:transform doc:name="Transform Payment Response">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    status: "SUCCESS",
    message: "Notification paiement traitée par Kit MuleSoft",
    numeroDeclaration: payload.numeroDeclaration,
    montantPaye: payload.montantPaye,
    dateTraitement: now(),
    kitProcessing: {
        correlationId: attributes.headers['x-correlation-id'] default uuid(),
        source: "KIT_INTERCONNEXION_UEMOA",
        storedInDatabase: true
    },
    timestamp: now()
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
    </flow>
    
    <!-- ✅ SUB-FLOWS pour traitement interne des étapes manquantes -->
    
    <!-- Sub-flow pour traçabilité Commission -->
    <sub-flow name="record-commission-trace" doc:id="59362d71-1bbd-4f62-83af-2d7853f0cce9">
        <ee:transform doc:name="Transform Commission Data">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    status: "RECORDED",
    message: "Opération UEMOA enregistrée avec succès par Kit MuleSoft",
    numeroOperation: payload.numeroOperation default (uuid() ++ "-" ++ (now() as String {format: "yyyyMMddHHmmss"})),
    typeOperation: payload.typeOperation default "OPERATION_UEMOA",
    paysOrigine: payload.paysOrigine default "UNKNOWN",
    paysDestination: payload.paysDestination default "UNKNOWN",
    horodatage: now(),
    kitProcessing: {
        correlationId: attributes.headers['x-correlation-id'] default uuid(),
        source: "KIT_INTERCONNEXION_COMMISSION",
        format: "UEMOA_2025.1"
    },
    commission: {
        traceability: "ENABLED",
        dataStored: true,
        analysisReady: true
    },
    timestamp: now()
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <logger level="INFO" message="📊 [Kit] Traçabilité Commission: #[payload.numeroOperation] enregistrée" doc:name="Log Commission Trace" />
    </sub-flow>
    
</mule>