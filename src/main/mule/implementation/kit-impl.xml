<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:http="http://www.mulesoft.org/schema/mule/http"
      xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

    <!-- âœ… FLOW 1: RÃ©ception Manifeste FORMAT UEMOA avec Supabase REST API -->
    <sub-flow name="receive-manifeste-from-pays-a" doc:id="676006f6-9481-4dd8-b0fa-f8e9fec8cccf" >
        <set-variable value="#['KIT_' ++ now() as String {format: 'yyyyMMddHHmmss'} ++ '_' ++ (random() * 1000) as String {format: '000'}]" 
                      doc:name="Set Correlation ID" variableName="correlationId"/>
        
        <set-variable value="#[payload]" doc:name="Set incoming" variableName="incoming"/>
        
        <logger level="INFO" message="ðŸ“¨ [Kit] RÃ©ception manifeste UEMOA: #[vars.incoming.numero_manif] depuis Pays A" doc:name="Log Manifeste Reception" />
        
        <!-- âœ… PrÃ©paration donnÃ©es pour Supabase REST API - FORMAT UEMOA -->
        <ee:transform doc:name="Transform UEMOA for Supabase REST" doc:id="795a2a7e-addc-4424-b5c0-22b22ad969f7">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    // âœ… Nouveaux champs format UEMOA
    numero_manifeste: vars.incoming.numero_manif as String,
    annee_manifeste: vars.incoming.annee_manif,
    bureau_manifeste: vars.incoming.bureau_manif,
    code_cgt: vars.incoming.code_cgt,
    consignataire: vars.incoming.consignataire,
    repertoire: vars.incoming.repertoire,
    
    // âœ… Informations navire UEMOA
    navire: vars.incoming.navire,
    provenance: vars.incoming.provenance,
    pavillon: vars.incoming.pavillon,
    date_arrivee: vars.incoming.date_arrivee,
    valeur_approximative: vars.incoming.valapprox,
    
    // âœ… MÃ©tadonnÃ©es
    pays_origine: "CIV",  // CÃ´te d'Ivoire par dÃ©faut
    pays_destination: vars.incoming.articles[0].pays_dest,
    nombre_articles: vars.incoming.nbre_article,
    
    // âœ… DonnÃ©es complÃ¨tes format UEMOA
    data_json: {
        format: "UEMOA",
        version: "2025.1",
        manifeste_complet: vars.incoming,
        articles_summary: vars.incoming.articles map ((article, index) -> {
            article_numero: article.art,
            description: article.marchandise,
            destination: article.pays_dest,
            poids_total: article.poids,
            conteneurs_count: sizeOf(article.conteneurs default [])
        }),
        correlationId: vars.correlationId,
        dateReception: now(),
        source_system: "PAYS_A_UEMOA"
    },
    date_reception: now(),
    statut: "RECU_UEMOA"
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <!-- âœ… Insertion via Supabase REST API - UTILISE LES VARIABLES YAML -->
        <http:request method="POST" doc:name="Insert Manifeste UEMOA via REST" config-ref="supabaseRestConfig" 
                      path="${supabase.rest.base_path}${supabase.rest.endpoints.manifestes}">
            <!-- Payload dÃ©jÃ  prÃ©parÃ© dans le transform prÃ©cÃ©dent -->
        </http:request>
        
        <logger level="INFO" message="âœ… [Kit] Manifeste UEMOA insÃ©rÃ© via REST API: #[vars.incoming.numero_manif]" doc:name="Log Insert Success" />
        
        <flow-ref name="route-to-destination-country" doc:name="Route to Destination Country" />
        <flow-ref name="notify-commission-uemoa" doc:name="Notify Commission UEMOA" />
        
        <ee:transform doc:name="Success Response UEMOA" doc:id="cb04616c-96aa-4f45-b4b1-ef9c55e5a2dd">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    status: "SUCCESS",
    message: "Manifeste UEMOA transmis avec succÃ¨s via REST API",
    numero_manif: vars.incoming.numero_manif,
    format: "UEMOA",
    consignataire: vars.incoming.consignataire,
    navire: vars.incoming.navire,
    nombre_articles: vars.incoming.nbre_article,
    correlationId: vars.correlationId,
    timestamp: now(),
    supabase: {
        endpoint: Mule::p('supabase.rest.base_path') ++ Mule::p('supabase.rest.endpoints.manifestes'),
        method: "POST",
        format_store: "UEMOA_2025"
    }
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <set-variable value="#[200]" doc:name="Set Success Status" variableName="http.status" />
    </sub-flow>

    <!-- FLOW 2: Routage vers Pays de Destination - FORMAT UEMOA -->
    <sub-flow name="route-to-destination-country" doc:id="f48e119e-c429-45f6-b4b8-277c8de1384c" >
        <logger level="INFO" message="ðŸš€ [Kit] Routage vers pays destination UEMOA: #[vars.incoming.articles[0].pays_dest]" doc:name="Log Routing" />
        
        <ee:transform doc:name="Transform UEMOA for Destination System" doc:id="57db70c7-b530-40d9-ba6c-ddb3eeb0ff1e">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    // âœ… Format adaptÃ© pour pays de destination avec donnÃ©es UEMOA
    manifeste: {
        format: "UEMOA",
        numero_origine: vars.incoming.numero_manif,
        annee_manifeste: vars.incoming.annee_manif,
        bureau_origine: vars.incoming.bureau_manif,
        consignataire: vars.incoming.consignataire,
        navire: vars.incoming.navire,
        provenance: vars.incoming.provenance,
        pavillon: vars.incoming.pavillon,
        date_arrivee: vars.incoming.date_arrivee,
        paysOrigine: "CIV",
        code_cgt: vars.incoming.code_cgt
    },
    
    // âœ… Articles transformÃ©s pour le pays de destination
    articles: vars.incoming.articles map ((article, index) -> {
        position: index + 1,
        numero_article: article.art,
        
        // Informations marchandise
        description: article.marchandise,
        poids_brut: article.poids,
        nombre_colis: article.nbre_colis,
        marque: article.marque,
        mode_conditionnement: article.mode_cond,
        
        // Informations expÃ©dition
        date_embarquement: article.date_emb,
        lieu_embarquement: article.lieu_emb,
        connaissement: article.connaissement,
        expediteur: article.expediteur,
        
        // Informations destination
        destinataire: article.destinataire,
        ville_destination: article.ville_dest,
        voie_destination: article.voie_dest,
        ordre: article.ordre,
        
        // Conteneurs dÃ©taillÃ©s
        conteneurs: article.conteneurs map ((conteneur, conteneurIndex) -> {
            numero: conteneur.conteneur,
            "type": conteneur."type",
            taille: conteneur.taille,
            plomb: conteneur.plomb
        }),
        nombre_conteneurs: article.nbre_conteneur,
        
        // PrÃ©cisions additionnelles
        precision_1: article.prec1,
        precision_2: article.prec2
    })
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <!-- âœ… UTILISE LES VARIABLES YAML pour l'endpoint -->
        <http:request method="POST" doc:name="Send UEMOA to Destination Country" 
                      path="${systeme.paysB.endpoints.manifeste}" config-ref="paysBConfig">
            <http:headers><![CDATA[#[{
    "Content-Type": "application/json",
    "X-Source-Country": "CIV",
    "X-Source-System": "KIT_INTERCONNEXION_UEMOA", 
    "X-Correlation-ID": vars.correlationId,
    "X-Manifeste-Format": "UEMOA"
}]]]></http:headers>
        </http:request>
        
        <logger level="INFO" message="âœ… [Kit] Manifeste UEMOA envoyÃ© avec succÃ¨s vers pays destination" doc:name="Log Routing Success" />
    </sub-flow>

    <!-- FLOW 3: Notification Commission UEMOA - FORMAT ENRICHI -->
    <sub-flow name="notify-commission-uemoa" doc:id="f526d669-a1a0-417b-a659-260cd4220c6e" >
        <async doc:name="Async Commission Notification">
            <logger level="INFO" message="ðŸ“Š [Kit] Notification Commission UEMOA pour manifeste: #[vars.incoming.numero_manif]" doc:name="Log Commission Notification" />
            
            <ee:transform doc:name="Transform UEMOA for Commission" doc:id="a2690e62-7c24-4fd1-8f82-30d457ef7091">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    typeOperation: "TRANSMISSION_MANIFESTE_UEMOA",
    numeroOperation: vars.incoming.numero_manif ++ "-" ++ vars.incoming.annee_manif ++ "-" ++ now() as String {format: "yyyyMMddHHmmss"},
    format: "UEMOA",
    paysOrigine: "CIV",
    paysDestination: vars.incoming.articles[0].pays_dest,
    
    // âœ… DonnÃ©es mÃ©tier enrichies format UEMOA
    donneesMetier: {
        numero_manifeste: vars.incoming.numero_manif,
        annee_manifeste: vars.incoming.annee_manif,
        bureau_manifeste: vars.incoming.bureau_manif,
        consignataire: vars.incoming.consignataire,
        navire: vars.incoming.navire,
        provenance: vars.incoming.provenance,
        pavillon: vars.incoming.pavillon,
        
        // Statistiques agrÃ©gÃ©es
        nombre_articles: vars.incoming.nbre_article,
        poids_total_estime: sum(vars.incoming.articles.poids),
        nombre_conteneurs_total: sum(vars.incoming.articles.nbre_conteneur),
        valeur_approximative: vars.incoming.valapprox,
        
        // Destinations multiples
        pays_destinations: vars.incoming.articles.pays_dest distinctBy $,
        villes_destinations: vars.incoming.articles.ville_dest distinctBy $,
        
        // Types de marchandises
        types_marchandises: vars.incoming.articles.marchandise distinctBy $,
        
        // Informations conteneurs
        types_conteneurs: flatten(vars.incoming.articles.conteneurs)."type" distinctBy $,
        tailles_conteneurs: flatten(vars.incoming.articles.conteneurs).taille distinctBy $
    },
    
    horodatage: now(),
    source: "KIT_INTERCONNEXION_UEMOA",
    version_format: "UEMOA_2025.1"
}]]></ee:set-payload>
                </ee:message>
            </ee:transform>
            
            <!-- âœ… UTILISE LES VARIABLES YAML pour l'endpoint -->
            <http:request method="POST" doc:name="Send to Commission UEMOA" 
                          path="${commission.uemoa.endpoints.tracabilite}" config-ref="commissionConfig">
                <http:headers><![CDATA[#[{
    "Authorization": "Bearer ${commission.uemoa.auth.token}",
    "Content-Type": "application/json",
    "X-Source-System": "KIT_INTERCONNEXION_UEMOA",
    "X-Correlation-ID": vars.correlationId,
    "X-Format": "UEMOA"
}]]]></http:headers>
            </http:request>
            
            <logger level="INFO" message="âœ… [Kit] Commission UEMOA notifiÃ©e avec succÃ¨s (format UEMOA)" doc:name="Log Commission Success" />
        </async>
    </sub-flow>

    <!-- âœ… FLOW 4: RÃ©ception Notification Paiement avec Supabase REST API -->
    <sub-flow name="receive-payment-notification" doc:id="acd305bc-43d0-4179-a8e4-3a115974ceca" >
        <set-variable value="#['PAY_' ++ now() as String {format: 'yyyyMMddHHmmss'} ++ '_' ++ (random() * 1000) as String {format: '000'}]" 
                      doc:name="Set Payment Correlation ID" variableName="correlationId"/>
        
        <set-variable value="#[payload]" doc:name="Set incoming" variableName="incoming" />
        
        <logger level="INFO" message="ðŸ’³ [Kit] RÃ©ception notification paiement: #[vars.incoming.numeroDeclaration]" doc:name="Log Payment Reception" />
        
        <!-- âœ… PrÃ©paration donnÃ©es paiement pour Supabase REST API -->
        <ee:transform doc:name="Transform Payment for Supabase REST" doc:id="32ecb9de-488d-4195-9ddf-921ea5377378">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    numero_declaration: vars.incoming.numeroDeclaration,
    manifeste_origine: vars.incoming.manifesteOrigine,
    montant_paye: vars.incoming.montantPaye,
    reference_paiement: vars.incoming.referencePaiement,
    date_paiement: vars.incoming.datePaiement,
    pays_declarant: vars.incoming.paysDeclarant,
    mode_paiement: vars.incoming.modePaiement default "ELECTRONIQUE",
    date_reception: now(),
    statut: "PAIEMENT_CONFIRME"
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <!-- âœ… Insertion paiement via Supabase REST API - UTILISE LES VARIABLES YAML -->
        <http:request method="POST" doc:name="Insert Payment via REST" config-ref="supabaseRestConfig" 
                      path="${supabase.rest.base_path}${supabase.rest.endpoints.paiements}">
            <!-- Payload dÃ©jÃ  prÃ©parÃ© dans le transform prÃ©cÃ©dent -->
        </http:request>
        
        <logger level="INFO" message="âœ… [Kit] Paiement insÃ©rÃ© via REST API: #[vars.incoming.numeroDeclaration]" doc:name="Log Payment Insert Success" />
        
        <flow-ref name="authorize-release-to-origin" doc:name="Authorize Release to Origin" />
        
        <ee:transform doc:name="Payment Confirmation Response" doc:id="90f7bdef-6946-47f1-8023-79bc336d7d81">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    status: "SUCCESS",
    message: "Paiement confirmÃ© via REST API, mainlevÃ©e autorisÃ©e",
    numeroDeclaration: vars.incoming.numeroDeclaration,
    correlationId: vars.correlationId,
    timestamp: now()
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
    </sub-flow>

    <!-- FLOW 5: Autorisation MainlevÃ©e - FORMAT UEMOA -->
    <sub-flow name="authorize-release-to-origin" doc:id="72ebe42d-10a7-427f-b1b8-dad353f9021e" >
        <logger level="INFO" message="ðŸ”“ [Kit] Autorisation mainlevÃ©e pour: #[vars.incoming.manifesteOrigine]" doc:name="Log Release Authorization" />
        
        <ee:transform doc:name="Transform Release Authorization UEMOA" doc:id="1fac44a9-5646-4dcd-b7b4-92de2375471e">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    autorisationMainlevee: {
        format: "UEMOA",
        numeroManifeste: vars.incoming.manifesteOrigine,
        numeroDeclaration: vars.incoming.numeroDeclaration,
        montantAcquitte: vars.incoming.montantPaye,
        paysDeclarant: vars.incoming.paysDeclarant,
        dateAutorisation: now(),
        referenceAutorisation: "AUTH-UEMOA-" ++ vars.incoming.numeroDeclaration ++ "-" ++ (now() as String {format: "yyyyMMddHHmmss"}),
        statut: "AUTORISE",
        
        // âœ… Informations additionnelles UEMOA
        typeAutorisation: "MAINLEVEE_INTER_PAYS",
        sourceKit: "KIT_INTERCONNEXION_UEMOA",
        conformiteUEMOA: true
    }
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <!-- âœ… UTILISE LES VARIABLES YAML pour l'endpoint -->
        <http:request method="POST" doc:name="Send Release Authorization UEMOA" 
                      path="${systeme.paysA.endpoints.mainlevee}" config-ref="paysAConfig">
            <http:headers><![CDATA[#[{
    "X-Correlation-ID": vars.correlationId,
    "Content-Type": "application/json",
    "X-Authorization-Source": "KIT_INTERCONNEXION_UEMOA",
    "X-Format": "UEMOA"
}]]]></http:headers>
        </http:request>
        
        <logger level="INFO" message="âœ… [Kit] Autorisation mainlevÃ©e UEMOA envoyÃ©e avec succÃ¨s" doc:name="Log Release Success" />
    </sub-flow>

    <!-- âœ… FLOW 6: TraÃ§abilitÃ© Commission UEMOA avec Supabase REST API -->
    <sub-flow name="record-commission-trace" doc:id="72c735e6-4d49-4cec-aaa3-f9e0ac91f8a2">
        <set-variable value="#[payload]" doc:name="Set incoming" variableName="incoming" />
        
        <logger level="INFO" message="ðŸ“Š [Kit] RÃ©ception traÃ§abilitÃ© Commission UEMOA: #[vars.incoming.numeroOperation]" doc:name="Log Commission Trace" />
        
        <!-- âœ… PrÃ©paration traÃ§abilitÃ© pour Supabase REST API -->
        <ee:transform doc:name="Transform Trace UEMOA for Supabase REST" doc:id="819f9ed3-1a40-47a8-a9a6-e00a833b6255">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    type_operation: vars.incoming.typeOperation,
    pays_source: vars.incoming.paysOrigine,
    pays_destination: vars.incoming.paysDestination,
    reference_operation: vars.incoming.numeroOperation,
    format_donnees: vars.incoming.format default "UEMOA",
    version_format: vars.incoming.version_format default "UEMOA_2025.1",
    payload_entrant: vars.incoming,
    statut_traitement: "ENREGISTRE",
    date_debut: now()
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <!-- âœ… Insertion traÃ§abilitÃ© via Supabase REST API - UTILISE LES VARIABLES YAML -->
        <http:request method="POST" doc:name="Insert Trace UEMOA via REST" config-ref="supabaseRestConfig" 
                      path="${supabase.rest.base_path}${supabase.rest.endpoints.tracabilite}">
            <!-- Payload dÃ©jÃ  prÃ©parÃ© dans le transform prÃ©cÃ©dent -->
        </http:request>
        
        <ee:transform doc:name="Commission Trace Response UEMOA" doc:id="26063168-213f-47c8-a5e4-13eb28efd26d">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    status: "RECORDED",
    message: "OpÃ©ration de traÃ§abilitÃ© UEMOA enregistrÃ©e avec succÃ¨s via REST API",
    numeroOperation: vars.incoming.numeroOperation,
    typeOperation: vars.incoming.typeOperation,
    format: vars.incoming.format default "UEMOA",
    timestamp: now(),
    commission: {
        statut: "ACQUITTE",
        horodatage: now(),
        conformite_uemoa: true
    }
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <set-variable value="#[200]" doc:name="Set Success Status" variableName="http.status" />
        
        <logger level="INFO" message="âœ… [Kit] TraÃ§abilitÃ© Commission UEMOA enregistrÃ©e via REST API" doc:name="Log Trace Success" />
    </sub-flow>

    <!-- âœ… FLOW 7: Health Check avec test Supabase REST API et support UEMOA -->
    <sub-flow name="health-check" doc:id="b1052d95-77d8-4785-a0d4-b8453bab57b9" >
        <!-- Test de connectivitÃ© Supabase -->
        <try doc:name="Test Supabase Connection">
            <!-- âœ… UTILISE LES VARIABLES YAML pour tester la connectivitÃ© -->
            <http:request method="GET" doc:name="Test Supabase REST" config-ref="supabaseRestConfig" 
                          path="${supabase.rest.base_path}${supabase.rest.endpoints.configurations}?limit=1">
                <!-- Simple requÃªte pour tester la connectivitÃ© -->
            </http:request>
            <set-variable value="UP" doc:name="Set Supabase Status UP" variableName="supabaseStatus" />
            <error-handler>
                <on-error-continue>
                    <set-variable value="DOWN" doc:name="Set Supabase Status DOWN" variableName="supabaseStatus" />
                </on-error-continue>
            </error-handler>
        </try>
		<ee:transform doc:name="Health Status Response UEMOA" doc:id="d16a70b2-a479-4161-b7fb-84d57d996a1f">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    service: "Kit Interconnexion UEMOA",
    status: "UP",
    version: "1.0.0-UEMOA",
    format_support: "UEMOA_2025.1",
    timestamp: now(),
    database: {
        "type": "Supabase REST API",
        status: vars.supabaseStatus default "UNKNOWN",
        endpoint: Mule::p('supabase.rest.base_url'),
        host: Mule::p('supabase.host')
    },
    endpoints: {
        manifesteTransmission: "/api/v1/manifeste/transmission",
        paiementNotification: "/api/v1/paiement/notification",
        tracabiliteEnregistrer: "/api/v1/tracabilite/enregistrer",
        healthCheck: "/api/v1/health",
        console: "/console"
    },
    configuration: {
        approach: "REST_API",
        format: "UEMOA",
        timeout: Mule::p('external.timeout.connection') ++ " ms",
        retryAttempts: Mule::p('retry.attempts'),
        corsEnabled: Mule::p('cors.enabled')
    },
    externalSystems: {
        supabase: {
            host: Mule::p('supabase.host'),
            status: vars.supabaseStatus default "UNKNOWN",
            method: "REST_API",
            endpoints: {
                manifestes: Mule::p('supabase.rest.endpoints.manifestes'),
                paiements: Mule::p('supabase.rest.endpoints.paiements'),
                tracabilite: Mule::p('supabase.rest.endpoints.tracabilite')
            }
        },
        paysA: {
            host: Mule::p('systeme.paysA.host'),
            status: "MONITORED",
            format_support: "UEMOA"
        },
        paysB: {
            host: Mule::p('systeme.paysB.host'),
            status: "MONITORED",
            format_support: "UEMOA"
        },
        commission: {
            host: Mule::p('commission.uemoa.host'),
            status: "MONITORED",
            format_support: "UEMOA"
        }
    },
    uemoa: {
        compliance: true,
        version: "2025.1",
        supported_fields: [
            "annee_manif", "bureau_manif", "numero_manif", "code_cgt",
            "consignataire", "navire", "provenance", "pavillon",
            "articles", "conteneurs"
        ]
    }
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <logger level="INFO" message="ðŸ¥ [Kit] Health check effectuÃ© - Supabase: #[vars.supabaseStatus] - Format: UEMOA" doc:name="Log Health Check" />
    </sub-flow>

</mule>