<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:http="http://www.mulesoft.org/schema/mule/http"
      xmlns:db="http://www.mulesoft.org/schema/mule/db"
      xmlns:json="http://www.mulesoft.org/schema/mule/json"
      xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw"
      xmlns:vm="http://www.mulesoft.org/schema/mule/vm"
      xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking"
      xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
        http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
        http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd
        http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd
        http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/current/mule-vm.xsd
        http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

    <!-- Configuration HTTP Listener pour le Kit d'Interconnexion -->

    <!-- Configuration HTTP Request pour Systèmes Externes -->

    <!-- Configuration Base de Données Kit -->

    <!-- FLOW 1: Réception Manifeste depuis Pays A -->

    <!-- FLOW 2: Routage vers Pays de Destination -->
    <sub-flow name="receive-manifeste-from-pays-a" doc:id="addc2992-3143-4c93-8fae-995c68812106" >
		<ee:transform doc:name="Validate and Transform Manifeste" doc:id="2a8b0271-35cd-415d-a8da-912c09a4451c">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    numeroManifeste: payload.numeroManifeste,
    transporteur: payload.transporteur,
    portEmbarquement: payload.portEmbarquement,
    portDebarquement: payload.portDebarquement,
    dateArrivee: payload.dateArrivee,
    marchandises: payload.marchandises map ((item, index) -> {
        codeSH: item.codeSH,
        designation: item.designation,
        poidsBrut: item.poidsBrut,
        nombreColis: item.nombreColis,
        destinataire: item.destinataire,
        paysDestination: item.paysDestination
    }),
    dateReception: now(),
    statut: "RECU"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<db:insert doc:name="Store Manifeste" config-ref="interconnexionDbConfig">
            <db:sql><![CDATA[INSERT INTO manifestes_recus 
                (numero_manifeste, transporteur, port_embarquement, port_debarquement, 
                 date_arrivee, pays_destination, data_json, date_reception, statut) 
                VALUES 
                (:numeroManifeste, :transporteur, :portEmbarquement, :portDebarquement, 
                 :dateArrivee, :paysDestination, :dataJson, :dateReception, :statut)]]></db:sql>
            <db:input-parameters><![CDATA[#[{
                numeroManifeste: payload.numeroManifeste,
                transporteur: payload.transporteur,
                portEmbarquement: payload.portEmbarquement,
                portDebarquement: payload.portDebarquement,
                dateArrivee: payload.dateArrivee,
                paysDestination: payload.marchandises[0].paysDestination,
                dataJson: write(payload, "application/json"),
                dateReception: payload.dateReception,
                statut: payload.statut
            }]]]></db:input-parameters>
        </db:insert>
		<flow-ref name="route-to-destination-country" doc:name="Route to Destination Country" />
		<flow-ref name="notify-commission-uemoa" doc:name="Notify Commission UEMOA" />
		<ee:transform doc:name="Success Response" doc:id="e7345de3-7f78-497b-9660-75c573cd5247">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    status: "SUCCESS",
    message: "Manifeste transmis avec succès",
    numeroManifeste: payload.numeroManifeste,
    timestamp: now()
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<set-variable value="#[200]" doc:name="Set Success Status" doc:id="829ec173-5ed9-4847-8230-d79c8dd53d0d" variableName="http.status" />
	</sub-flow>

    <!-- FLOW 3: Notification Commission UEMOA -->
    <sub-flow name="route-to-destination-country" doc:id="c461114e-c9f3-4b38-9107-b3ae34c3fc27" >
		<logger level="INFO" message="Routage vers pays destination: #[payload.marchandises[0].paysDestination]" doc:name="Log Routing" />
		<ee:transform doc:name="Transform for Destination System" doc:id="14853548-ac2f-413f-bcbf-bab42f88e2c8">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    manifeste: {
        numeroOrigine: payload.numeroManifeste,
        transporteur: payload.transporteur,
        portOrigine: payload.portEmbarquement,
        dateArrivee: payload.dateArrivee,
        paysOrigine: "CIV" // Exemple Côte d'Ivoire
    },
    marchandises: payload.marchandises map ((item, index) -> {
        position: index + 1,
        codeTarifaire: item.codeSH,
        description: item.designation,
        poidsNet: item.poidsBrut,
        quantite: item.nombreColis,
        importateur: item.destinataire,
        valeurEstimee: 0 // À compléter par déclarant
    })
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<http:request method="POST" doc:name="Send to Destination Country" doc:id="23ca1e61-4f33-4b98-88a0-88a8d0ada690" path="/api/v1/manifeste/reception" config-ref="paysBConfig">
			<http:headers><![CDATA[#[output application/java
---
{
	"X-Source-Country" : "CIV",
	"X-Correlation-ID" : "Value",
	"Content-Type" : "#[correlationId]"
}]]]></http:headers>
		</http:request>
		<logger level="INFO" message="Manifeste envoyé avec succès vers pays destination" doc:name="Log Success" />
	</sub-flow>
	<sub-flow name="notify-commission-uemoa" doc:id="14fca646-b00d-4192-bb8e-10dd2f30b737" >
		<async doc:name="Async Commission Notification">

            <ee:transform doc:name="Transform for Commission" doc:id="0ba794b1-4959-41ec-8d58-4ff4bcc70968">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    typeOperation: "TRANSMISSION_MANIFESTE",
    numeroOperation: payload.numeroManifeste ++ "-" ++ now() as String {format: "yyyyMMddHHmmss"},
    paysOrigine: "CIV",
    paysDestination: payload.marchandises[0].paysDestination,
    donneesMetier: {
        numeroManifeste: payload.numeroManifeste,
        transporteur: payload.transporteur,
        nombreMarchandises: sizeOf(payload.marchandises),
        valeurTotaleEstimee: sum(payload.marchandises.poidsBrut) * 100 // Estimation simplifiée
    },
    horodatage: now(),
    source: "KIT_INTERCONNEXION"
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<http:request method="POST" doc:name="Send to Commission" doc:id="3b02c48c-0287-498e-8518-d4cf01d1c07e" path="/api/v1/tracabilite/enregistrer" config-ref="commissionConfig">
				<http:headers><![CDATA[#[output application/java
---
{
	"Authorization" : "Bearer COMMISSION_TOKEN",
	"Content-Type" : "application/json"
}]]]></http:headers>
			</http:request>
        </async>
	</sub-flow>

    <!-- FLOW 4: Réception Notification Paiement depuis Pays B -->
    <sub-flow name="receive-payment-notification" doc:id="467a8d5e-2cd8-4c6a-b244-3ed7704d0f63" >
		<ee:transform doc:name="Validate Payment Notification" doc:id="8ee4728a-ae2d-4e46-a301-95234294387a">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    numeroDeclaration: payload.numeroDeclaration,
    manifesteOrigine: payload.manifesteOrigine,
    montantPaye: payload.montantPaye,
    referencePaiement: payload.referencePaiement,
    datePaiement: payload.datePaiement,
    paysDeclarant: payload.paysDeclarant,
    statut: "PAIEMENT_CONFIRME"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<db:insert doc:name="Store Payment" config-ref="interconnexionDbConfig">
            <db:sql><![CDATA[INSERT INTO paiements_recus 
                (numero_declaration, manifeste_origine, montant_paye, reference_paiement, 
                 date_paiement, pays_declarant, date_reception, statut) 
                VALUES 
                (:numeroDeclaration, :manifesteOrigine, :montantPaye, :referencePaiement, 
                 :datePaiement, :paysDeclarant, :dateReception, :statut)]]></db:sql>
            <db:input-parameters><![CDATA[#[{
                numeroDeclaration: payload.numeroDeclaration,
                manifesteOrigine: payload.manifesteOrigine,
                montantPaye: payload.montantPaye,
                referencePaiement: payload.referencePaiement,
                datePaiement: payload.datePaiement,
                paysDeclarant: payload.paysDeclarant,
                dateReception: now(),
                statut: payload.statut
            }]]]></db:input-parameters>
        </db:insert>
		<flow-ref name="authorize-release-to-origin" doc:name="Authorize Release to Origin" />
		<ee:transform doc:name="Payment Confirmation Response" doc:id="b0650a9a-642b-4ecb-ada2-697f75b1acaa">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    status: "SUCCESS",
    message: "Paiement confirmé, mainlevée autorisée",
    numeroDeclaration: payload.numeroDeclaration,
    timestamp: now()
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>

    <!-- FLOW 5: Autorisation Mainlevée vers Pays d'Origine -->

    <!-- FLOW 6: API de Santé et Status -->
    <sub-flow name="authorize-release-to-origin" doc:id="ad41dfd3-9427-44ab-bc78-52b9f12af1b9" >
		<logger level="INFO" message="Autorisation mainlevée pour: #[payload.manifesteOrigine]" doc:name="Log Release Authorization" />
		<ee:transform doc:name="Transform Release Authorization" doc:id="3c159df0-614c-479d-8ce2-b550d76fc183">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    autorisationMainlevee: {
        numeroManifeste: payload.manifesteOrigine,
        numeroDeclaration: payload.numeroDeclaration,
        montantAcquitte: payload.montantPaye,
        paysDeclarant: payload.paysDeclarant,
        dateAutorisation: now(),
        referenceAutorisation: "AUTH-" ++ payload.numeroDeclaration ++ "-" ++ (now() as String {format: "yyyyMMddHHmmss"}),
        statut: "AUTORISE"
    }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<http:request method="POST" doc:name="Send Release Authorization" doc:id="7538dbe1-e695-47e8-8497-2b3a351a2b88" path="/api/v1/mainlevee/autorisation" config-ref="paysAConfig">
			<http:headers><![CDATA[#[output application/java
---
{
	"X-Correlation-ID" : "#[correlationId]",
	"Content-Type" : "application/json",
	"X-Authorization-Source" : "KIT_INTERCONNEXION"
}]]]></http:headers>
		</http:request>
		<logger level="INFO" message="Autorisation mainlevée envoyée avec succès" doc:name="Log Release Success" />
	</sub-flow>
	<sub-flow name="health-check" doc:id="772118a7-a161-4028-b397-4329f887c22a" >
		<ee:transform doc:name="Health Status Response" doc:id="00aff913-c416-49c2-af19-6d8a483ec9bb">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    service: "Kit Interconnexion UEMOA",
    status: "UP",
    version: "1.0.0-POC",
    timestamp: now(),
    endpoints: {
        manifesteReception: "/api/v1/manifeste/transmission",
        paiementNotification: "/api/v1/paiement/notification",
        healthCheck: "/api/v1/health"
    }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>

    <!-- Gestion d'erreurs globale -->

</mule>